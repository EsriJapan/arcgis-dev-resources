+++
title = "BA データからカスタム変数を作成"
description = "BA データから独自のカスタム変数を作成します。"
weight = 23
alwaysopen = false
data = 2021-10-28T17:07:25+09:00
author = "石橋"
draft = false
+++

{{< callout >}}

本演習にかかる時間はおよそ 30 分です。

{{< /callout >}}

本演習では、Business Analyst ローカル データセット（以下、BA データ）を使用して、独自のカスタム変数を作成する方法を学びます。

## 演習用データのダウンロード

1. <a href="https://www.arcgis.com/home/item.html?id=9c5537b16711429289c90422b55229fa" target="_blank">BA Pro チュートリアル-カスタマイズ プロジェクトパッケージ</a>をダウンロードします。
2. ダウンロードした「BAProチュートリアル-カスタマイズ.ppkx」を開き、[演習1] マップを開きます。

{{< callout >}}

[Business Analyst データ ソース](/business-analyst/pro/tutorial/prepare-for-tutorial/#business-analyst-データ-ソースの設定) が最新のデータセットに設定されていることをご確認ください。

{{< /callout >}}
## 統計データ コレクションの作成

BA データに搭載されている町丁・字等ポリゴンを使用して、統計データ コレクションを作成します。

{{< callout >}}

統計データ コレクション（.sdcx）は、Business Analyst 上で使用するための設定を格納するファイルです。 (<a href="https://pro.arcgis.com/ja/pro-app/latest/help/analysis/business-analyst/custom-data.htm" target="_blank">詳細</a>)

{{< /callout >}}

1. [解析] タブ → [ワークフロー] グループの [ビジネス解析] ボタン → [新しい統計データ コレクション] をクリックします。
2. [統計データ コレクションの作成] ダイアログが開いたら、[入力データ] 右部にある参照ボタンをクリックし、以下のフィーチャクラスを選択します。
    > <データセット配置先>\JPN_EsriJapan_2025\Data\Demographic Data\JPN_EsriJapan_2025.gdb\Blocks_blk

3. [統計データ コレクションの出力] で作成する統計データ コレクションの名前および保存先を確認し、そのまま [作成] をクリックします。

[SDCX の編集] ダイアログが開きます。

## カスタム変数の設定

独自の計算式を用いてカスタム変数を設定します。今回は、既存の BA データには無い「5~14 歳人口」変数を作成します。

1. [変数] タブを開き、1 つ目のフィールド「D0001」行をクリックして選択状態にします。
2. [Ctrl + A] を押して、すべてのフィールドを選択状態にして、チェックを外します。

これにより、すべてのフィールドが未選択の状態になりました。次に、計算に利用するフィールドのみを選択します。

3. 次に、以下のフィールドにチェックを入れます。
    - D0007 (2020 人口 5-9歳)
    - D0008 (2020 人口 10-14歳)

{{< callout >}}

ダイアログ右上の検索ボックスに、フィールド名もしくはエイリアスを入力することで、変数を検索できます。

{{< /callout >}}

5. [計算の追加] をクリックして [変数の計算] ダイアログを開きます。
6. 以下のように設定し、[OK] をクリックします。
    - 言語：Python
    - フィールド名：D_POP_5_14
    - エイリアス：2020 人口 5-14歳
    - 式：!D0007!+!D0008!

{{< callout >}}

[フィールド] 内のフィールド名をダブルクリックすると、式に追加することができます。<br/>
また、[確認] (緑のチェック マーク) をクリックすると、作成した式に問題が無いかを確認することができます。

{{< /callout >}}

使用するフィールドの集計時の按分方法を設定します。また、同時にエイリアスやカテゴリーを指定することもできます。

7. チェックを入れた 2 つの変数の割り当て方法（按分方法）を [GEOM]（面積按分）に変更します。

|フィールド名|エイリアス|カテゴリ|年代|精度|フィールド形式|サマリー タイプ|加重|割り当て方法|種類|
|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|
|D0007|2020 人口 5-9歳|既定||0|Count|合計|なし|GEOM|Double|
|D0008|2020 人口 10-14歳|既定||0|Count|合計|なし|GEOM|Double|

{{< callout >}}

作成したカスタム変数は、フィールド一覧の一番下に追加されます。

{{< /callout >}}

{{< callout >}}

カスタム変数の作成時に設定可能な割り当て方法は、<a href="https://www.esrij.com/cgi-bin/wp/wp-content/uploads/documents/ge2025-variablelist-jp.xlsx" target="_blank">利用可能な統計データの一覧</a>をご確認ください。

{{< /callout >}}

カスタム変数を使用する際のタイトルやアイコンなどを設定します。

8. [プロパティ] タブを開き、[タイトル] に「BAデータカスタム変数」と入力します。また、タグやアイコンを任意に設定します。
9. [OK] をクリックしてダイアログを閉じます。

最後に、作成した統計データ コレクションの名前を変更します。

10. [カタログ] ウィンドウ → [Business Analyst] → [統計データ コレクション] を展開します。
11. Blocks_blk.sdcx 上で右クリックし、[名前の変更] をクリックして、「BAデータカスタム変数.sdcx」に名前を変更します。

{{< callout >}}

作成した統計データ コレクションには、デフォルトでデータ ソースとして選択したフィーチャクラスの名前が付けられます。

{{< /callout >}}

{{< callout >}}

[SDCX の編集] ダイアログ上の [パフォーマンス インデックス] の工具マークをクリックし、インデックスを構築すると、集計パフォーマンスを向上させることができます。ただし、日本全国をカバーするレイヤーに対するインデックスのため、構築完了までに長時間かかることにご注意ください。

{{< /callout >}}

## 商圏にカスタム変数を集計する

商圏に対してカスタム変数として作成した「2020 人口 5-14歳」を集計します。

1. [解析] タブ → [ジオプロセシング] グループの [ツール] をクリックし、[ツールの検索] に「情報付加」と入力します。
2. 検索結果の中の [<a href="https://pro.arcgis.com/ja/pro-app/latest/tool-reference/business-analyst/enrich-layer-advanced.htm" target="_blank">レイヤーの情報付加 (Enrich Layer)</a>] ツールをクリックして開きます。
3. [入力フィーチャ] 横の [鉛筆] アイコンをクリックし、[ポリゴン] を選択します。
4. マップ上の任意の範囲にポリゴンを作成して、ダブルクリックで完成させます。
5. [出力フィーチャクラス] に「任意ポリゴン_カスタム変数付与」と入力します。
6. [変数] で [+] ボタンをクリックしてデータ ブラウザーを開き、[カスタム データ] ノード → [BAデータカスタム変数] をクリックして開きます。
7. [既定] カテゴリにチェックを入れて格納されているすべての変数を選択し、[OK] をクリックしてデータ ブラウザーを閉じます。
8. [実行] をクリックしてツールを実行します。

{{< callout >}}

統計データ コレクションのインデックスが未構築、もしくは最新でない場合は、以下のような警告が表示されます。この警告はインデックスが存在しないことを表しますが、集計自体は正常に行えます。

{{< figure src="https://s3.ap-northeast-1.amazonaws.com/doc.esrij.com/business-analyst/pro/tutorial/customize-data/warning-about-sdcx-index.png" title="パフォーマンス インデックスに関する警告" width="40%" >}}

{{< /callout >}}

ツール実行が完了すると、マップに結果レイヤーが追加されます。集計結果を確認します。

9. [コンテンツ] ウィンドウ上の「任意ポリゴン_カスタム変数付与」レイヤーを選択し、Ctrl + T で属性テーブルを開き、右にスクロールします。

「2020 人口 5-14歳」フィールド値が、以下の 2 つのフィールドの合算値であり、カスタム変数が正しく集計されていることが分かります。
- 2020 人口 5-9歳
- 2020 人口 10-14歳

10. [プロジェクト] タブ → [保存] を選択し、<a href="https://pro.arcgis.com/ja/pro-app/latest/help/projects/save-a-project.htm" target="_blank">プロジェクトを保存</a>します。

# まとめ

この演習では、BA データを使用して統計データ コレクションを作成しました。さらに、カスタムの計算式を設定することで、既存のデータには無いカスタム変数を作成し、その変数を任意の商圏に集計しました。
また、以下のツールの操作を学びました。

- [統計データ コレクションの作成] ツール

