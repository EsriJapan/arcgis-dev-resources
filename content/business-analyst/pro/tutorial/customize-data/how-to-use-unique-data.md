+++
title = "独自データからカスタム変数を作成"
description = "売上情報などの自社の独自データをカスタム変数として登録します。"
weight = 24
alwaysopen = false
data = 2021-10-28T17:07:25+09:00
author = "石橋"
draft = false
publishDate = 2021-11-19T00:00:00+09:00
+++

{{< callout >}}

本演習にかかる時間はおよそ 30 分です。

{{< /callout >}}

区画別に集計した顧客数や売上高など、独自の数値情報を持つデータを使用して、カスタム変数として登録する方法を学びます。本演習では、千葉県内の自社顧客データを用いて、町丁・字等ポリゴンを作成し、それを独自変数として登録します。

## 演習用データのダウンロード

1. <a href="https://www.arcgis.com/home/item.html?id=9c5537b16711429289c90422b55229fa" target="_blank">BA Pro チュートリアル-カスタマイズ プロジェクトパッケージ</a>をダウンロードします。
2. ダウンロードした「BAProチュートリアル-カスタマイズ.ppkx」を開き、[演習2] マップを開きます。

{{< callout >}}

[Business Analyst データ ソース](/business-analyst/pro/tutorial/prepare-for-tutorial/#business-analyst-データ-ソースの設定) が最新のデータセットに設定されていることをご確認ください。

{{< /callout >}}

## 売上情報を含むテーブル データの確認

プロジェクトパッケージはデフォルト設定では、以下の場所に展開されます。
> C:\Users\<ユーザー名>\Documents\ArcGIS\Packages\BAProチュートリアル-カスタマイズ_xxxx

統計データ コレクションのデータ ソースとなる、町丁・字等別に集計した顧客数・売上情報を含むテーブル データをマップに追加します。

1. [マップ] タブ → [レイヤー] グループの [データの追加] をクリックします。
2. [データ] を選択して、[データの追加] ダイアログを開きます。
3. 演習データ内の Excel シートを選択し、[OK] をクリックします。
    > <上記展開先>\commondata\userdata\町丁字等別売上情報.xlsx\町丁字等別売上情報$

{{< callout >}}

Excel の読み込みができない場合、[事前準備](/business-analyst/pro/tutorial/prepare-for-tutorial/)をご確認ください。

{{< /callout >}}

{{< callout >}}

[フォルダー] に上記展開先のパスが接続されているため、[フォルダー] から Excel ファイルに接続することができます。

{{< /callout >}}

[コンテンツ] ウィンドウに「町丁字等別売上情報$」が追加されます。

1. 「町丁字等別売上情報$」を右クリック → [開く] をクリックし、テーブルを開きます。
2. テーブルに、町丁・字等の区画 ID や区画名、顧客数や売上高などの売上情報が含まれることを確認し、テーブルを閉じます。

{{< figure src="https://s3.ap-northeast-1.amazonaws.com/doc.esrij.com/business-analyst/pro/tutorial/customize-data/create-custom-variables/confirm-a-table.png" title="売上情報を含むテーブル データ">}}

## 町丁・字等ポリゴンの作成

追加したテーブル データを使用して、統計データ コレクションのデータ ソースとなる町丁・字等ポリゴンを作成します。

1. [解析] タブ → [ジオプロセシング] グループの [ツール] をクリックし、[ジオプロセシング] ウィンドウの検索ボックスに「標準区画商圏」と入力します。
2. 検索結果の中の [<a href="https://pro.arcgis.com/ja/pro-app/latest/tool-reference/business-analyst/generate-standard-geography-trade-areas.htm" target="_blank">標準区画商圏の生成 (Generate Standard Geography Trade Areas)</a>] ツールをクリックして開きます。
3. ツールが開いたら、以下のように設定して [実行] をクリックします。
    パラメーター | 設定値
    -- | --
    区画レベル | 町丁・字等 (JP.Blocks)
    出力フィーチャクラス | 町丁字等別売上情報
    入力タイプ | テーブル
    区画 ID テーブル | 町丁字等別売上情報$
    区画キー フィールド | リンクコード

{{< callout >}}

[入力タイプ] パラメーターを「テーブル」に設定した場合、[区画キー フィールド] はテキスト型である必要があります。

{{< /callout >}}

{{< callout >}}

[標準区画商圏の生成] ツールでは、上記のように区画 ID を含むテーブルを基に商圏を作成できるほか、区画リストから、任意の区画を選択して商圏を作成することもできます。<br/>
その場合は、[入力タイプ] パラメーターを「リスト」に設定し、[区画 ID リスト] パラメーターの [参照] ボタンから [区画の選択] ダイアログを開き、追加したい区画を選択します。<br/>
{{< figure src="https://s3.ap-northeast-1.amazonaws.com/doc.esrij.com/business-analyst/pro/tutorial/customer-analysis/select-geography-from-list.png" title="区画リストから選択">}}

{{< /callout >}}

ツールが完了したら、マップ上に町丁・字等ポリゴンが追加されます。属性テーブルを開いて、集計結果を確認します。

4. [コンテンツ] ウィンドウの「町丁字等別売上情報」を右クリック → [属性テーブル] をクリックします。
5. 属性テーブルが開いたら右にスクロールし、先ほど確認した顧客数や売上数等の情報を、出力されたポリゴンが持っていることを確認し、テーブルを閉じます。

これで、統計データ コレクションを作成するためのデータ ソースを作成することができました。

## 統計データ コレクションの作成

{{< callout >}}

統計データ コレクションのデータ ソースとして指定できるのは、数値情報を持つポリゴン データのみです。

{{< /callout >}}

次に、作成した町丁・字等ポリゴンを使用して統計データ コレクションを作成し、カスタム変数を登録します。

1. [解析] タブ → [ワークフロー] グループの [ビジネス解析] ボタン → [新しい統計データ コレクション] をクリックします。
2. [統計データ コレクションの作成] ダイアログで、[入力データ] のドロップダウンをクリックし、[町丁字等別売上情報] を選択します。
3. [統計データ コレクションの出力] で作成する統計データ コレクションの名前および保存先を確認し、[作成] をクリックします。

[SDCX の編集] ダイアログが開きます。このダイアログ内で、変数のカテゴリや集計方法等の詳細な設定を行うことができます。


4. [変数] タブを開き、以下のフィールド名の行にのみチェックが入っていることを確認します。
    - 売上高
    - 売上数
    - 顧客数

{{< callout >}}

本演習では独自データが持つフィールドのみ使用しますが、[変数の追加] から、Business Analyst ローカル データセットに搭載の変数を追加できます。

{{< /callout >}}

5. チェックを入れた変数のエイリアスやカテゴリなどを、以下の通りに設定します。

|フィールド名|エイリアス|カテゴリ|年代|精度|フィールド形式|サマリー タイプ|加重|割り当て方法|出力タイプ|
|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|
|売上高|売上高|売上||1|Currency|合計|なし|GEOM|Double|
|売上数|売上数|売上||1|Count|合計|なし|GEOM|Double|
|顧客数|顧客数|顧客||0|Count|合計|なし|GEOM|Double|

{{< callout >}}

[変数] タブで設定できる各項目の定義は、以下の通りです。<br/>

<div class="info-table">

|項目|説明|
|:-|:--|
|フィールド名|フィールドの名前。編集はできません。|
|エイリアス|データ ブラウザーで表示される見かけ上の名称。|
|カテゴリ|変数のカテゴリ。変数が多い場合に設定すると、変数の検索時に見つけやすくなります。|
|年代|変数の年代を定義します。|
|精度|変数の集計時にどの小数点まで算出するかを定義します。|
|フィールド形式|変数の形式を定義します。数字 (Count)、割合 (Precent)、通貨 (Currency) のいずれかを指定できます。|
|サマリー タイプ|変数の集計方法を定義します。合計と平均のいずれかを指定できます。|
|加重|サマリー タイプを「平均」にした場合に指定します。たとえば「顧客あたりの平均売上」を変数に設定する場合、「顧客数」を加重に設定します。|
|割り当て方法|変数の集計時に使用される加重按分の方法を定義します。|
|出力タイプ|フィールドの<a href="https://pro.arcgis.com/ja/pro-app/2.7/help/data/geodatabases/overview/arcgis-field-data-types.htm" target="_blank">データ タイプ</a>。編集はできません。|
</div>
<br/>

{{< /callout >}}

6. [プロパティ] タブを開き、以下の通りに設定します。
    - タイトル: 町丁字等別売上情報
    - アイコン: アイコン ボタンをクリックし、[その他] カテゴリの中から $ マークを選択します。
7. [OK] をクリックしてダイアログを閉じます。

{{< callout >}}

統計データ コレクション (*.sdcx ファイル) に対してインデックスを作成することで、集計のパフォーマンスが向上します。<br/>
*.sdcx ファイルを参照しているフィーチャクラスや *.sdcx ファイル自体に変更を加えた場合には、その都度インデックスを再構築する必要があります。構築は、[<a href="https://pro.arcgis.com/ja/pro-app/latest/tool-reference/business-analyst/generate-sdcx-index.htm" target="_blank">SDCX インデックスの生成 (Generate SDCX Index)</a>] ツールからも実行できます。

{{< /callout >}}

## 商圏にカスタム変数を集計する

商圏に作成したカスタム変数と標準変数を集計します。

1.	[解析] タブ → [ワークフロー] グループの [ビジネス解析] → [クイック商圏] をクリックします。
2.	[場所検索] タブで、検索ボックスに「西船橋駅」と入力し、Enter キーを押します。
3.	検索結果が表示されるので、選択して [次へ] をクリックします。
4.	[リング商圏] タブで、以下のように設定し、[次へ] をクリックします。
    - 半径: 「1」、「2」と入力します。（※ 3 つ目は空欄にします。）
    - ディゾルブ オプション: ディスク
5. [情報付加] を有効にし、[+] ボタンをクリックします。
6. [人口] カテゴリー → [人口総数] → [2020 人口総数] にチェックを入れます。
7. [カスタム データ] ノードを選択し、「町丁字等別売上情報」カテゴリを開き、[顧客数] にチェックを入れて、[OK] をクリックします。
8. [次へ] を選択し、[完了] をクリックしてツールを実行します。

マップに、西船橋駅を中心とする 1km/2km のリング商圏が生成され、指定した変数が集計したレイヤーが追加されます。結果の詳細を確認します。

9. [コンテンツ] ウィンドウ上の「情報付加バッファー」レイヤーを右クリック → [属性テーブル] を開きます。

{{< callout >}}

属性テーブルは、[コンテンツ] ウィンドウで対象のレイヤーをクリックして選択した状態で、Ctrl + T でも開くことができます。

{{< /callout >}}

10. 属性テーブルを右側にスクロールして、人口総数と顧客数が同時に集計できていることを確認します。

このような分析を通じて、市場ポテンシャルを確認しつつ、既存店への影響を評価することができます。

{{< figure src="https://s3.ap-northeast-1.amazonaws.com/doc.esrij.com/business-analyst/pro/tutorial/customize-data/result-enrich-layer2.png" title="カスタムデータの情報付加">}}

11. [プロジェクト] タブ → [保存] を選択し、<a href="https://pro.arcgis.com/ja/pro-app/latest/help/projects/save-a-project.htm" target="_blank">プロジェクトを保存</a>します。

# まとめ

この演習では、顧客数や売上情報を持つ町丁・字等の一覧が載ったテーブルを使用して、統計データ コレクションのデータ ソースとなる町丁・字等ポリゴンを作成しました。
さらに、作成したポリゴンを元に統計データ コレクションを作成し、カスタム変数を利用するための各種設定を行い、商圏に対して集計を行いました。
また、以下のツールの操作を学びました。

- [標準区画商圏の生成] ツール
- [統計データ コレクションの作成] ツール

<style class="info-table">
table {
    font-size: 13px;
    width: 85%;
    margin-right: 5px;
    margin-left: 15px;
}

table tr{
    background-color: #ffffff;
}
</style>

